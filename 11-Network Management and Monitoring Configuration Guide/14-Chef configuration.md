
# Configuring Chef

## About Chef

Chef is an open-source configuration management tool. It uses the
Ruby language. You can use the Ruby language to create cookbooks and save them
to a server, and then use the server for centralized configuration enforcement
and management.

### Chef network framework

Figure 1 Chef network framework

![](https://resource.h3c.com/en/202407/12/20240712_11705761_x_Img_x_png_0_2216119_294551_0.png)

 

As shown in [Figure 1](#_Ref433631622), Chef operates
in a client/server network framework. Basic Chef network components include the
Chef server, Chef clients, and workstations.

#### Chef server

The Chef server is used to centrally manage
Chef clients. It has the following functions:

·     Creates and deploys cookbooks to Chef clients on
demand.

·     Creates .pem key
files for Chef clients and workstations. Key files include the following two
types:

¡     User key file—Stores user authentication information for a Chef client or a
workstation. The Chef server uses this file to verify the validity of a Chef
client or workstation. Before the Chef client or workstation initiates a
connection to the Chef server, make sure the user key file is downloaded to the
Chef client or workstation.

¡     Organization key file—Stores authentication
information for an organization. For management convenience, you can classify Chef
clients or workstations that have the same type of attributes into organizations.
The Chef server uses organization key files to verify the validity of
organizations. Before a Chef client or workstation initiates a connection to
the Chef server, make sure the organization key file is downloaded to the Chef
client or workstation.

For information about installing and
configuring the Chef server, see the official Chef website at

<https://www.chef.io>.

#### Workstation

Workstations provide the interface for you to
interact with the Chef server. You can create or modify cookbooks on a
workstation and then upload the cookbooks to the Chef server.

A workstation can be hosted by the same
host as the Chef server. For information about installing and configuring the
workstation, see the official Chef website at

<https://www.chef.io>.

#### Chef client

Chef clients are network devices managed by
the Chef server. Chef clients download cookbooks from the Chef server and use the
settings in the cookbooks.

The device supports Chef 12.3.0 client.

### Chef resources

Chef uses Ruby to define configuration items.
A configuration item is defined as a resource. A cookbook contains a set of resources
for one feature.

Chef manages types of resources. Each
resource has a type, a name, one or more properties, and one action. Every property
has a value. The value specifies the state desired for the resource. You can
specify the state of a device by setting values for properties regardless of
how the device enters the state. The following resource example shows how to
configure a device to create VLAN 2 and configure the description for VLAN 2\.

netdev\_vlan 'vlan2' do

 vlan\_id 2

 description 'chef-vlan2'

 action :create

end

The following are the resource type,
resource name, properties, and actions:

·     netdev\_vlan—Type of the resource.

·     vlan2—Name of the resource. The name is the unique identifier of the
resource.

·     do/end—Indicates the beginning and end of
a Ruby block that contains properties and actions. All Chef resources must be
written by using the do/end
syntax.

·     vlan\_id—Property for specifying a VLAN. In this example, VLAN 2 is
specified.

·     description—Property for configuring the description. In this example, the description
for VLAN 2 is chef-vlan2.

·     create—Action for creating or modifying a resource. If the resource does
not exist, this action creates the resource. If the resource already exists, this
action modifies the resource with the new settings. This action is the default
action for Chef. If you do not specify an action for a resource, the create action is used.

·     delete—Action for deleting a resource.

Chef supports only the create and delete actions.

For more information about resource types
supported by Chef, see "[Chef resources](#_Ref434218154)."

### Chef configuration file

You can manually configure a Chef
configuration file. A Chef configuration file contains the following items:

·     Attributes for log messages generated by a Chef
client.

·     Directories for storing the key files on the
Chef server and Chef client.

·     Directory for storing the resource files on the
Chef client.

After Chef starts up, the Chef client sends
its key file specified in the Chef configuration file to the Chef server for
authentication request. The Chef server compares its local key file for the
client with the received key file. If the two files are consistent, the Chef
client passes the authentication. The Chef client then downloads the resource
file to the directory specified in the Chef configuration file, loads the
settings in the resource file, and outputs log messages as specified.

Table 1 Chef configuration file description

| Item | Description |
| --- | --- |
| (Optional.) log\_level | Severity level for log messages.  Available values include :auto, :debug, :info, :warn, :error, and :fatal. The severity levels in ascending order are listed as follows:  ·     :debug  ·     :info  ·     :warn (:auto)  ·     :error  ·     :fatal  The default severity level is :auto, which is the same as :warn. || log\_location | Log output mode:  ·     STDOUT—Outputs standard Chef success log messages to a file. With this mode, you can specify the destination file for outputting standard Chef success log messages when you execute the third-part-process start command. The standard Chef error log messages are output to the configuration terminal.  ·     STDERR—Outputs standard Chef error log messages to a file. With this mode, you can specify the destination file for outputting standard Chef error log messages when you execute the third-part-process start command. The standard Chef success log messages are output to the configuration terminal.  ·     logfilepath—Outputs all log messages to a file, for example, flash:/cheflog/a.log.  If you specify none of the options, all log messages are output to the configuration terminal. || node\_name | Chef client name.  A Chef client name is used to identify a Chef client. It is different from the device name configured by using the sysname command. || chef\_server\_url | URL of the Chef server and name of the organization created on the Chef server, in the format of https://localhost:port/organizations/ORG\_NAME.  The localhost argument represents the name or IP address of the Chef server. The port argument represents the port number of the Chef server.  The ORG\_NAME argument represents the name of the organization. || validation\_key | Path and name of the local organization key file, in the format of flash:/chef/validator.pem. || client\_key | Path and name of the local user key file, in the format of flash:/chef/client.pem. || cookbook\_path | Path for the resource files, in the format of \[ 'flash:/chef-repo/cookbooks' ]. |







 

## Restrictions and guidelines: Chef configuration

The Chef server cannot run a lower version
than Chef clients.

## Prerequisites for Chef

Before configuring Chef on the device, complete
the following tasks on the device:

·     Enable NETCONF over SSH. The Chef server sends configuration
information to Chef clients through NETCONF over SSH. For information about
NETCONF over SSH, see "Configuring NETCONF."

·     Configure SSH login. Chef clients communicate
with the Chef server through SSH. For information about SSH login, see Fundamentals Configuration Guide.

## Starting Chef

### Configuring the Chef server

**1\.**Create key files for the workstation and the
Chef client.

**2\.**Create a Chef configuration file for the
Chef client.

For more information about configuring the
Chef server, see the Chef server installation and configuration guides.

### Configuring a workstation

**1\.**Create the working path for the workstation.

**2\.**Create the directory for storing the Chef
configuration file for the workstation.

**3\.**Create a Chef configuration file for the
workstation.

**4\.**Download the key file for the workstation
from the Chef server to the directory specified in the workstation
configuration file.

**5\.**Create a Chef resource file.

**6\.**Upload the resource file to the Chef server.

For more information about configuring a
workstation, see the workstation installation and configuration guides.

### Configuring a Chef client

**1\.**Download the key file from the Chef server
to a directory on the Chef client.

The directory must be the same as the
directory specified in the Chef client configuration file.

**2\.**Download the Chef configuration file from
the Chef server to a directory on the Chef client.

The directory must be the same as the
directory that will be specified by using the --config\=filepath option in the third-part-process start command.

**3\.**Start Chef on the device:

**a.**Enter system view.

system-view

**b.**Start Chef.

third-part-process start name chef-client arg
--config\=filepath --runlist recipe\[Directory]

By default, Chef is shut down.

 

| Parameter | Description |
| --- | --- |
| --config\=filepath | Specifies the path and name of the Chef configuration file. || --runlist recipe\[Directory] | Specifies the name of the directory that contains files and subdirectories associated with the resource. |


 

For more information about the third-part-process
start command, see "Monitoring and
maintaining processes."

## Shutting down Chef

#### Prerequisites

Before you shut down Chef, execute the display process
all command to identify the ID of the Chef
process. This command displays information about all processes on the device.
Check the following fields:

·     THIRD—This field displays Y for a third-party
process.

·     COMMAND—This field displays chef-client /opt/ruby/b
for the Chef process.

·     PID—Process ID.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Shut down Chef.

third-part-process stop pid pid-list

For more information about the third-part-process
stop command, see "Monitoring and
maintaining processes."

## Chef configuration examples

### Example: Configuring Chef

#### Network configuration

As shown in [Figure 2](#_Ref433724255), the
device is connected to the Chef server. Use Chef to configure the device to
create VLAN 3\.

Figure 2 Network diagram

![](https://resource.h3c.com/en/202407/12/20240712_11705762_x_Img_x_png_1_2216119_294551_0.png)

 

#### Procedure

**1\.**Configure the Chef server:

\# Create user key file admin.pem for
the workstation. Specify the workstation username as Herbert George Wells, the Email address as [\[email protected]](/cdn-cgi/l/email-protection), and the password as 123456.

$ chef-server-ctl user-create Herbert
George Wells [\[email protected]](/cdn-cgi/l/email-protection) 123456 –filename\=/etc/chef/admin.pem

\# Create organization key file admin\_org.pem
for the workstation. Specify the abbreviated organization name as ABC and the
organization name as ABC Technologies
Co., Limited. Associate the organization with the
user Herbert.

$ chef-server-ctl org-create ABC\_org
"ABC Technologies Co., Limited" –association\_user Herbert –filename
\=/etc/chef/admin\_org.pem

\# Create user key file client.pem for
the Chef client. Specify the Chef client username as Herbert George Wells, the Email address as [\[email protected]](/cdn-cgi/l/email-protection), and the password as 123456.

$ chef-server-ctl user-create Herbert
George Wells [\[email protected]](/cdn-cgi/l/email-protection) 123456 –filename\=/etc/chef/client.pem

\# Create organization key file validator.pem
for the Chef client. Specify the abbreviated organization name as ABC and the
organization name as ABC Technologies
Co., Limited. Associate the organization with the
user Herbert.

$ chef-server-ctl org-create ABC
"ABC Technologies Co., Limited" –association\_user Herbert –filename
\=/etc/chef/validator.pem

\# Create Chef configuration file chefclient.rb
for the Chef client.

log\_level :info 

log\_location STDOUT

node\_name 'Herbert'

chef\_server\_url 'https://1.1.1.2:443/organizations/abc'

validation\_key 'flash:/chef/validator.pem'

client\_key 'flash:/chef/client.pem'


cookbook\_path \[ 'flash:/chef-repo/cookbooks'
]

**2\.**Configure the workstation:

\# Create the chef-repo directory on the
workstation. This directory will be used as the working path.

$ mkdir /chef-repo

\# Create the .chef directory. This directory will
be used to store the Chef configuration file for the workstation.

$ mkdir –p /chef-repo/.chef

\# Create Chef configuration file knife.rb in the /chef-repo/.chef0 directory.

log\_level                :info

log\_location            
STDOUT

node\_name               
'admin'

client\_key              
'/root/chef-repo/.chef/admin.pem'

validation\_key          
'/root/chef-repo/.chef/admin\_org.pem'

chef\_server\_url         
'https://chef-server:443/organizations/abc'

\# Use TFTP or FTP to download the key
files for the workstation from the Chef server to the /chef-repo/.chef
directory on the workstation. (Details not shown.)

\# Create resource directory netdev.

$ knife cookbook create netdev

After the command is executed, the netdev directory
is created in the current directory. The directory contains files and
subdirectories for the resource. The recipes directory stores the resource
file.

\# Create resource file default.rb in
the recipes directory.

netdev\_vlan 'vlan3' do

 vlan\_id 3

 action :create

end

\# Upload the resource file to the Chef
server.

$ knife cookbook upload –all

**3\.**Configure the Chef client:

\# Configure SSH login and enable NETCONF
over SSH on the device. (Details not shown.)

\# Use TFTP or FTP to download Chef
configuration file chefclient.rb from the Chef server to the root directory of the Flash memory on
the Chef client. Make sure this directory is the same as the directory
specified by using the --config\=filepath
option in the third-part-process start command.

\# Use TFTP or FTP to download key files validator.pem
and client.pem from the Chef server to the flash:/chef/ directory.

\# Start Chef. Specify the Chef
configuration file name and path as flash:/chefclient.rb and the resource
file name as netdev.

\<ChefClient\> system-view

\[ChefClient] third-part-process
start name chef-client arg --config\=flash:/chefclient.rb --runlist
recipe\[netdev]

After the command is executed, the Chef
client downloads the resource file from the Chef server and loads the settings
in the resource file.

