
# Configuring gRPC

## About gRPC

gRPC is an open source remote procedure
call (RPC) system initially developed at Google. It uses HTTP 2.0 and provides
network device configuration and management methods that support multiple
programming languages.

### gRPC protocol stack layers

[Table 1](#_Ref518908368)
describes the gRPC protocol stack layers.

Table 1 gRPC protocol stack layers

| Layer | Description |
| --- | --- |
| Content layer | Defines the data of the service module.  Two peers must notify each other of the data models that they are using. || Protocol buffer encoding layer | Encodes data by using the protocol buffer code format. || gRPC layer | Defines the protocol interaction format for remote procedure calls. || HTTP 2.0 layer | Carries gRPC. || TCP layer | Provides connection-oriented reliable data links. |





 

### Networkarchitecture

As shown in [Figure 1](#_Ref505181531), the gRPC
network uses the client/server model. It uses HTTP 2.0 for packet transport.

Figure 1 gRPC
networkarchitecture

![](https://resource.h3c.com/en/202407/12/20240712_11705874_x_Img_x_png_0_2216137_294551_0.png)

 

The gRPC network uses the following
mechanism:

**1\.**The gRPC server listens to connection
requests from clients at the gRPC service port.

**2\.**A user runs the gRPC client application to
log in to the gRPC server, and uses methods provided in the .proto file to send
requests.

**3\.**The gRPC server responds to requests from
the gRPC client.

The device can act as the gRPC server or
client.

### Telemetry technology based on gRPC

Telemetry is a remote data collection
technology for monitoring device performance and operating status. H3C
telemetry technology uses gRPC to push data from the device to the collectors
on the NMSs. As shown in [Figure 2](#_Ref518629664), after
a gRPC connection is established between the device and NMSs, the NMSs can
subscribe to data of modules on the device.

Figure 2 Telemetry technology based on gRPC

![](https://resource.h3c.com/en/202407/12/20240712_11705875_x_Img_x_png_1_2216137_294551_0.png)

 

### Telemetry modes

The device supports the following telemetry
modes:

·     Dial-in mode—The device acts as a gRPC server and the collectors act as gRPC
clients. A collector initiates a gRPC connection to the device to subscribe to
device data.

Dial-in mode supports the following
operations:

¡     Get—Obtains device status and
settings.

¡     CLI—Executes commands on the device.

¡     gNMI—gRPC Network Management
Interface operations, which include the following subtypes of operations:

\-     gNMI Capabilities—Obtains the capacities of the device.

\-     gNMI Get—Obtains
the status and settings of the device.

\-     gNMI Set—Deploys
settings to the device.

\-     gNMI Subscribe—Subscribes
to data push services provided by the device. The data might be generated by
periodical data collection or event-triggered data collection. 

·     Dial-out mode—The device acts as a gRPC client and the collectors act as gRPC
servers. The device initiates gRPC connections to the collectors and pushes
device data to the collectors as configured.

### gNMI

gRPC Network Management Interface (gNMI) is
a gRPC-based protocol for network device management. It defines a series of RPC
methods to obtain or configure the states of devices.

The device supports gNMI and non-gNMI subscriptions
for pushing data to a collector. 

### Protocols

RFC 7540, Hypertext
Transfer Protocol version 2 (HTTP/2)

## FIPS compliance

The device supports the FIPS mode that
complies with NIST FIPS 140-2 requirements. Support for features, commands, and
parameters might differ in FIPS mode and non-FIPS mode. For more information
about FIPS mode, see Security Configuration Guide.

gRPC is not supported in FIPS mode.

## Restrictions and guidelines: gRPC configuration

Disabling the gRPC service deletes all
gRPC-related settings.

## gRPC configuration tasks at a glance

Configure gRPC dial-in and dial-out modes
as needed:

**1\.**Configuring the gRPC dial-in mode

Configure gRPC dial-in when the device
acts as a gRPC server to communicate with collectors that act as gRPC clients. 

**a.**[Configuring the
gRPC service](#_Ref114170828)

**b.**[Configuring a gRPC
user](#_Ref114170875)

**c.**(Optional.) [Enabling gRPC logging in dial-in mode](#_Ref114170883)

**2\.**Configuring the gRPC dial-out mode

Configure gRPC dial-out when the device
acts as a gRPC client to communicate with collectors that act as gRPC servers.

**a.**[Enabling the gRPC
service](#_Ref114171965)

**b.**[Configuring sensors](#_Ref114171974)

**c.**[Configuring
collectors](#_Ref114171987)

**d.**[Configuring a
subscription](#_Ref114171993)

**e.**(Optional.) [Enabling gRPC logging in dial-out mode](#_Ref114172001)

**3\.**(Optional.) [Specifying the PKI domain for secure communication with collectors](#_Ref114172008)

**4\.**(Optional.) [Setting the maximum CPU usage for gRPC](#_Ref114172014)

## Configuring the gRPC dial-in mode

### Configuring the gRPC service

**1\.**Enter system view.

system-view

**2\.**Enable the gRPC service.

grpc enable

By default, the gRPC service is disabled.

**3\.**(Optional.) Set the gRPC service port
number.

grpc port port-number

By default, the gRPC service port number
is 50051\.

**4\.**(Optional.) Set the gRPC session idle
timeout timer.

grpc idle-timeout minutes

By default, the gRPC session idle timeout
timer is 5 minutes.

### Specifying the PKI domain for secure communication with collectors

#### About this task

By default, the gRPC connection between the
device and a collector does not provide data encryption service or require
authentication. After you specify a PKI domain, the device and the collector
will use TLS for data encryption and bidirectional certificate-based
authentication to improve communication security.

#### Restrictions and guidelines

The specified PKI domain must already exist
and has correct certificate and key settings. For more information about PKI
domains, see PKI configuration in Security Configuration
Guide.

After you specify the PKI domain, the gRPC
service will reboot, closing the connections to collectors. The collectors must
re-initiate the connections.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Specify the PKI domain for secure
communication with collectors.

grpc pki domain domain-name

By default, no PKI domain is specified
for secure communication with collectors.

### Configuring a gRPC user

#### About this task

For gRPC clients to establish gRPC sessions
with the device, you must configure local users for the gRPC clients.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Add a local user with the device management
right.

local-user user-name \[ class manage ]

**3\.**Configure a password for the user.

password \[ { hash \| simple } password ]

By default, no password is configured for
a local user. A non-password-protected user can pass authentication after
providing the correct username and passing attribute checks.

**4\.**Assign user role network-admin to the user.

authorization-attribute user-role user-role

By default, a local user is assigned the
network-operator role.

**5\.**Authorize the user to use the HTTPS service.

service-type https

By default, no service types are
authorized to a local user.

For more information about the local-user, password, authorization-attribute, and service-type commands,
see AAA configuration in Security Command Reference.

### Enabling gRPC logging in dial-in mode

#### About this task

To identify issues with gRPC in dial-in
mode, enable gRPC operations logging in dial-in mode. 

This feature generates gRPC operation logs
in dial-in mode and sends them to the information center. 

With the information center, you can
configure log destinations and output rules. For more information about the
information center, see Network Management and
Monitoring Configuration Guide.

#### Restrictions and guidelines

gRPC operation logging might degrade device
performance if gRPC operations are frequent. As a best practice, use gRPC
operation logging only when necessary and log only gRPC operations of interest
if gRPC operation logging is enabled.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Enable gRPC logging in dial-in mode. Choose
the options to configure as needed:

¡     Enable
gRPC logging for RPC operations in dial-in mode.

grpc log dial-in rpc { all \| { cli \| get }\* }

By default, gRPC logging is disabled for
RPC operations in dial-in mode.

¡     Enable
gRPC logging for gNMI operations in dial-in mode.

grpc log dial-in gnmi { all \| { capabilities \| get \| set \| subscribe }\* }

By default, gRPC logging is enabled for
gNMI Set operations and disabled for other gNMI operations in dial-in mode.

## Configuring the gRPC dial-out mode

### Enabling the gRPC service

**1\.**Enter system view.

system-view

**2\.**Enable the gRPC service.

grpc enable

By default, the gRPC service is disabled.

### Specifying the PKI domain for secure communication with collectors

#### About this task

By default, the gRPC connection between the
device and a collector does not provide data encryption service or require
authentication. After you specify a PKI domain, the device and the collector
will use TLS for data encryption and bidirectional certificate-based
authentication to improve communication security.

#### Restrictions and guidelines

The specified PKI domain must already exist
and has correct certificate and key settings. For more information about PKI
domains, see PKI configuration in Security Configuration
Guide.

After you specify the PKI domain, the gRPC
service will reboot, closing the connections to collectors. The device will
automatically re-initiate the connections.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Specify the PKI domain for secure
communication with collectors.

grpc pki domain domain-name

By default, no PKI domain is specified
for secure communication with collectors.

### Configuring sensors

#### About this task

A sensor is a data path from which the
device collects data and then pushes the data to a collector. You can create a
sensor group and then specify sensor paths in the group. Sensor groups include non-gNMI
sensor groups and gNMI sensor groups. If the collector uses gNMI, you must
create gNMI sensor groups.

A sensor path supports either event-trigged
or periodic data collection. 

·     Event-triggered—The device pushes data from the sensor path to the collector when
certain events occur. For information about event-triggered sensor paths, see NETCONF XML API Event Reference for the module.

·     Periodic—The device pushes data from the sensor path to the collector at
intervals. For information about periodic sensor paths, see the NETCONF XML API
references for the module except for NETCONF XML API Configuration
Reference and NETCONF XML API Data Reference.

·     Condition-triggered—The device checks the data of the sensor path periodically and pushes
the data from the sensor path to the collector when certain conditions are met.
For information about condition-triggered sensor paths, the sensor path check
interval, and data push conditions, contact H3C Support.

Condition-triggered sensor paths are
supported only by gNMI sensor groups.

#### Restirctions and guidelines

As a best practice for the device to push
data from sensor paths, specify sensor paths of the same type in a sensor
group.

#### Configuring a non-gNMI sensor group

**1\.**Enter system view.

system-view

**2\.**Enter telemetry view.

telemetry

**3\.**Create a non-gNMI sensor group and enter
sensor group view.

sensor-group group-name

**4\.**Specify a sensor path.

sensor path path \[ selection-nodes node-list ]

To specify multiple sensor paths, execute
this command multiple times. If you execute this command multiple times with
the same sensor path specified, the most recent configuration takes effect.

#### Configuring a gNMI sensor group

**1\.**Enter system view.

system-view

**2\.**Enter telemetry view.

telemetry

**3\.**Create a gNMI sensor group and enter sensor
group view.

sensor-group group-name gnmi

To enter the view of an existing gNMI
sensor group, you do not need to specify the gnmi keyword.

**4\.**Specify a sensor path.

sensor path path \[ selection-nodes node-list ]

To specify multiple sensor paths, execute
this command multiple times.

### Configuring collectors

#### About this task

Collectors receive sampled data from
network devices. For the device to communicate with collectors, you must create
a destination group and add collectors to the destination group.

You can add collectors to a destination
group by their IP addresses or domain names. When you specify collectors by
their domain names, use the following restrictions and guidelines:

·     You must configure DNS to make sure the device
can translate the domain names of the collectors to IP addresses. For more
information about DNS, see Layer 3—IP Services Configuration
Guide. 

·     To  view domain name and IP address mappings,
use the display dns host command. If a domain
name maps to multiple IP addresses, the device will push data to the first
reachable IP address.

To encrypt the gRPC connections between the
device and the target collector, use one of the following methods:

·     Enable TLS encryption globally for all gRPC
connections by executing the grpc pki domain command in system view. The device uses the TLS certificates in the
specified PKI domain for encryption.

·     Enable collector-specific TLS encryption by
specifying the tls keyword when you add
a collector to a destination group. The device uses one root TLS certificate
that came with it to encrypt the gRPC connection to the specified collector.

For a collector, the setting in system view
has higher priority than the collector-specific setting.

#### Restrictions and guidelines

As a best practice, configure a maximum of
five destination groups. If you configure too many destination groups, system
performance might degrade.

#### Prerequisites

To configure a collector that resides in a VPN
instance, configure the VPN instance first.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Enter telemetry view.

telemetry

**3\.**Create a destination group and enter
destination group view.

destination-group group-name

**4\.**Add a collector to the destination group by
its IP address.

IPv4:

ipv4-address ipv4-address \[ port port-number ] \[ vpn-instance vpn-instance-name ] \[ tls ]

IPv6:

ipv6-address ipv6-address \[ port port-number ] \[ vpn-instance vpn-instance-name ] \[ tls ]

The IPv6 address cannot be a link-local
address. For more information about link-local addresses, see IPv6 basics
configuration in Layer 3—IP Services Configuration Guide.

To add multiple collectors, repeat this
command. A collector is uniquely identified by a three-tuple of IP address,
port number, and VPN instance name. One collector must have a different IP
address, port number, or VPN instance name than the other collectors in the
destination group.

**5\.**Add a collector to the destination group by
its domain name.

IPv4:

domain-name domain-name \[ port port-number ] \[ vpn-instance vpn-instance-name ] \[ tls ]

IPv6:

ipv6 domain-name domain-name \[ port port-number ] \[ vpn-instance vpn-instance-name ] \[ tls ]

To add multiple collectors, repeat this
command. A collector is uniquely identified by a three-tuple of domain name,
port number, and VPN instance name. One collector must have a different domain
name, port number, or VPN instance name than the other collectors in the
destination group.

### Configuring a subscription

#### About this task

A subscription binds sensor groups to
destination groups. Then, the device pushes data from the specified sensors to
the collectors in the destination groups.

Subscriptions include non-gNMI subscriptions
and gNMI subscriptions. To push data to a collector that uses gNMI, you must
configure a gNMI subscription.

#### Restrictions and guidelines

For a non-gNMI subscription, specify non-gNMI
sensor groups. 

For a gNMI subscription, specify gNMI
sensor groups.

You cannot use a destination group in both
a gRPC subscription and a gNMI subscription.

For the device to correctly push data from
sensor paths in a sensor group, make sure the subscription settings for the
sensor paths are compliant with [Table 2](#_Ref64637964).

Table 2 Compatibility of sensor path types
and subscription settings

| Sensor path type | Push mode | Data push interval | Data push suppression interval || Periodical | Default | Configured | Not configured || Event-triggered | Default | Not configured | Not configured || Condition-triggered | Condition-triggered | Not configured | Configured |



| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

 

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Enter telemetry view.

telemetry

**3\.**Create a subscription and enter subscription
view.

¡     Create
a non-gNMI subscription and enter subscription view.

subscription subscription-name

¡     Create a gNMI subscription and
enter subscription view.

subscription subscription-name gnmi

To enter the view of an existing gNMI subscription, you do not need to
specify the gnmi keyword.

**4\.**(Optional.) Set the data push mode.

push-mode condition-triggered

Perform this step only if a sensor group
specified for a subscription contains condition-triggered sensor paths.

This command is available only for gNMI
subscriptions.

By default, the data push mode for a
sensor path in a subscription is periodical or event-triggered.

**5\.**(Optional.) Set the DSCP value for packets
sent to collectors.

dscp dscp-value

By default, the DSCP value for packets
sent to collectors is 0\.

A greater DSCP value represents a higher
priority.

**6\.**(Optional.) Specify the source IP address
for packets sent to collectors.

source-address { ipv4-address \| interface
interface-type interface-number \| ipv6 ipv6-address }

By default, the device uses the primary
IPv4 address of the output interface for the route to the collectors as the
source address.

Changing the source IP address for
packets sent to collectors causes the device to re-establish the connection to
the gRPC server.

**7\.**(Optional.) Enable per-row time-stamping for
JSON-encoded subscription data.

json row-timestamp enable

By default, the device time-stamps
JSON-encoded subscription data on a per-message basis.

Per-row subscription data time-stamping
is not available for gNMI subscriptions.

**8\.**Specify a sensor group.

sensor-group group-name \[ sample-interval \[ msec ] interval \| suppress-time suppress-time ]

By default, no sensor groups are
specified.

 

| Parameter | Description || sample-interval | Data push interval.  Specify this parameter only for periodic sensor paths. || suppress-time | Data push suppression interval.  Specify this parameter only for condition-triggered sensor paths. |


| --- | --- | --- | --- | --- | --- |

 

**9\.**Specify a destination group.

destination-group group-name

By default, no destination groups are
specified.

### Enabling gRPC logging in dial-out mode

#### About this task

To identify issues with gRPC in dial-out
mode, enable gRPC data collection logging in dial-out mode. 

This feature generates gRPC data collection
logs in dial-out mode and sends them to the information center. 

With the information center, you can
configure log destinations and output rules. For more information about the
information center, see Network Management and
Monitoring Configuration Guide.

#### Restrictions and guidelines

gRPC logging in dial-out mode is unavailable
for gNMI subscriptions.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Enable gRPC logging in dial-out mode. 

grpc log dial-out { all \| { event \| sample }\* }

By default, gRPC logging is disabled in
dial-out mode.

## Specifying the PKI domain for secure communication with collectors

#### About this task

By default, the gRPC connection between the
device and a collector does not provide data encryption service or require
authentication. After you specify a PKI domain, the device and the collector
will use TLS for data encryption and bidirectional certificate-based
authentication to improve communication security.

#### Restrictions and guidelines

The specified PKI domain must already exist
and has correct certificate and key settings. For more information about PKI
domains, see PKI configuration in Security Configuration
Guide.

After you specify the PKI domain, the gRPC function
will reboot, closing the connections to collectors. In dial-in mode, the
collectors must re-initiate the connections. In dial-out mode, the device will
automatically re-initiate the connections.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Specify the PKI domain for secure
communication with collectors.

grpc pki domain domain-name

By default, no PKI domain is specified
for secure communication with collectors.

## Setting the maximum CPU usage for gRPC

#### About this task

gRPC data sampling is CPU intensive. To prevent
gRPC from negatively affecting other services, limit its maximum CPU usage. If
the specified maximum CPU usage is exceeded during data sampling, gRPC suspends
data sampling until after its CPU usage drops below the specified limit.

#### Procedure

**1\.**Enter system view.

system-view

**2\.**Specify the PKI domain for secure
communication with collectors.

grpc cpu-usage max-percent percentage

By default, No CPU usage limit is set for
gRPC.

## Display and maintenance commands forgRPC

Execute display commands
in any view.

 

| Task | Command |
| --- | --- |
| Display gRPC information. | display grpc \[ verbose ] || Display periodic sensor paths that have the minimum sampling interval. | display telemetry sensor-path |


 

## gRPC configuration examples

These configuration examples describe only CLI
configuration tasks on the device. The collectors need to run an extra
application. For information about collector-side application development, see "[Developing the collector-side application](#_Ref518908551)."

### Example: Configuring the gRPC dial-in mode

#### Network configuration

As shown in [Figure 3](#_Ref317084462),
configure the gRPC dial-in mode on the device so the device acts as the gRPC
server and the gRPC client can subscribe to LLDP events on the device.

Figure 3 Network diagram

![](https://resource.h3c.com/en/202407/12/20240712_11705876_x_Img_x_png_2_2216137_294551_0.png)

 

#### Procedure

**1\.**Assign IP addresses to interfaces on the
gRPC server and client and configure routes. Make sure the server and client
can reach each other.

**2\.**Configure the device as the gRPC server:

\# Enable the gRPC service.

\<Device\> system-view

\[Device] grpc enable

\# Create a local user named test. Set the
password of the user, and assign user role network-admin and the HTTPS service to
the user.

\[Device] local-user test

\[Device-luser-manage-test]
password simple 123456TESTplat\&!

\[Device-luser-manage-test]
authorization-attribute user-role network-admin

\[Device-luser-manage-test]
service-type https

\[Device-luser-manage-test] quit

**3\.**Configure the gRPC client.

**a.**Prepare a PC and install the gRPC
environment on the PC. For more information, see the user guide for the gRPC
environment.

**b.**Obtain the H3C proto definition file and
uses the protocol buffer compiler to generate code of a specific language, for
example, Java, Python, C/C\+\+, or Go.

**c.**Create a client application to call the
generated code.

**d.**Start the application to log in to the gRPC
server.

#### Verifying the configuration

When an LLDP event occurs on the gRPC
server, verify that the gRPC client receives the event.

### Example: Configuring event-triggered telemetry in gRPC dial-out mode

#### Network configuration

As shown in [Figure 4](#_Ref89336264), the
device acts as a gRPC client and connects to the telemetry data collector (a
gRPC server). The collector receives data on port 50050\.

Configure the device to operate in dial-out
mode to push interface event data to the collector.

Figure 4 Network diagram

![](https://resource.h3c.com/en/202407/12/20240712_11705877_x_Img_x_png_3_2216137_294551_0.png)

 

#### Restrictions and guidelines

When you execute the sensor-group command in subscription view to specify a sensor group that
contains event-triggered sensor paths for a subscription, do not use the sample-interval to set a data push interval. 

 

|  | NOTE:  An event-triggered sensor path typically contains a string of event in its path name. |
| --- | --- |

 

#### Procedure

\# Configure IP addresses as required so the
device and the collector can reach each other. (Details not shown.)

\# Enable gRPC.

\<Device\> system-view

\[Device] grpc enable

\# Create a sensor group named Test, and add sensor path ifmgr/interfaceevent
to it.

\[Device] telemetry

\[Device-telemetry] sensor-group Test

\[Device-telemetry-sensor-group-Test]
sensor path ifmgr/interfaceevent

\[Device-telemetry-sensor-group-Test]
quit

\# Create a destination group named collector1 and add a collector to the group. In this
example, the collector receives data on port 50050 at IPv4 address 192.168.2.1.

\[Device-telemetry] destination-group
collector1

\[Device-telemetry-destination-group-collector1]
ipv4-address 192.168.2.1 port 50050

\[Device-telemetry-destination-group-collector1]
quit

\# Configure a subscription named B to bind sensor group Test
with destination group collector1.

\[Device-telemetry] subscription B

\[Device-telemetry-subscription-B]
sensor-group Test 

\[Device-telemetry-subscription-B]
destination-group collector1

\[Device-telemetry-subscription-B]
quit

#### Verifying the configuration

Access the collector and verify that the
collector can receive the interface event data pushed by the device. (Details
not shown.)

### Example: Configuring the gRPC dial-out mode

#### Network configuration

As shown in [Figure 5](#_Ref518908577), the
device is connected to a collector. The collector uses port 50050\.

Configure gRPC dial-out mode on the device
so the device pushes the device capability information of its interface module
to the collector at 10-second intervals.

Figure 5 Network diagram

![](https://resource.h3c.com/en/202407/12/20240712_11705878_x_Img_x_png_4_2216137_294551_0.png)

 

#### Procedure

\# Configure IP addresses as required so the
device and the collector can reach each other. (Details not shown.)

\# Enable the gRPC service.

\<Device\> system-view

\[Device] grpc enable

\# Create a sensor group named test, and add sensor path ifmgr/devicecapabilities/.

\[Device] telemetry

\[Device-telemetry] sensor-group test

\[Device-telemetry-sensor-group-test]
sensor path ifmgr/devicecapabilities/

\[Device-telemetry-sensor-group-test]
quit

\# Create a destination group named collector1. Specify a collector that uses IPv4 address
192.168.2.1 and port number 50050\.

\[Device-telemetry] destination-group
collector1

\[Device-telemetry-destination-group-collector1]
ipv4-address 192.168.2.1 port 50050

\[Device-telemetry-destination-group-collector1]
quit

\# Configure a subscription named A to bind sensor group test
with destination group collector1. Set the data
push interval to 10 seconds.

\[Device-telemetry] subscription A

\[Device-telemetry-subscription-A]
sensor-group test sample-interval 10

\[Device-telemetry-subscription-A]
destination-group collector1

\[Device-telemetry-subscription-A]
quit

#### Verifying the configuration

\# Verify that the collector receives the device
capability information of the interface module from the device at 10-second
intervals. (Details not shown.)

 

